#!/usr/bin/env bash
################################################################
# The file provides docker compose functions to start, execute
# tests and stop the docker compose containers.
################################################################

################################################################
# Function initialize environment variables and loads the common functions
function initializeVariables() {
  : "${WORKDIR?"Need to set WORKDIR"}"

  FUNCTION_FOLDER="$(cd -P $(dirname ${BASH_SOURCE[0]} ) && pwd)"
  # project folder
  SMP_PROJECT_FOLDER=$(readlink -e "${FUNCTION_FOLDER}/../../..")
  #load common functions
  source "${FUNCTION_FOLDER}/common.functions"
  echo "Set Working Directory: ${WORKDIR}"
  cd "${WORKDIR}" || exit 100
  [ -f "${WORKDIR}/.env" ] && source "${WORKDIR}/.env"

  initializeCommonVariables
  discoverApplicationVersion
}


################################################################
# Function exports the logs to file and stop and clear containers
function stopAndClearTestContainers() {
  echo "Save docker log to docker-file"
  docker logs "${PLAN_PREFIX}" > smp-container.log 2>&1
  echo "Clear containers and volumes"
  docker-compose -p "${PLAN_PREFIX}" rm -s -f -v
}

################################################################
# Function exports the logs to file and stop and clear containers
function startTestContainers() {
  echo "Start containers with prefix ${PLAN_PREFIX}"
  docker compose -p "${PLAN_PREFIX}" up -d --force-recreate --wait --wait-timeout 300
}

